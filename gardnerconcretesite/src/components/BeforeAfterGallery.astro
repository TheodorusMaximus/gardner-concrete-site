---
import Card from './ui/Card.astro';
import Button from './ui/Button.astro';
import { getProjects } from '../utils/wix-client.js';

// Fetch projects from Wix CMS (will fall back to static data if no CMS)
let projectData = [];
try {
  projectData = await getProjects('transformations');
} catch (error) {
  console.log('Using static transformation data');
}

// Fallback to static data with placeholder images for now
const transformationProjects = projectData.length > 0 ? projectData : [
  {
    _id: "1",
    title: "Foundation Wall Stabilization",
    location: "Longfellow, Minneapolis",
    category: "Foundation Repair",
    beforeImage: "https://images.unsplash.com/photo-1573161103-e6fc8c2e1dbc?auto=format&fit=crop&w=800&q=80",
    afterImage: "https://images.unsplash.com/photo-1590224505923-372138a3b8bd?auto=format&fit=crop&w=800&q=80",
    description: "Severe foundation wall bowing due to clay soil expansion. Steel I-beam reinforcement with drainage upgrade restored structural integrity permanently.",
    customerQuote: "Gardner Concrete saved our home. The wall was bowing 3 inches - we thought we'd have to move. Now it's rock solid.",
    customerName: "Sarah & Mike Johnson",
    timeframe: "4 days",
    year: "2024",
    featured: true
  },
  {
    _id: "2", 
    title: "Basement Waterproofing System",
    location: "Highland Park, St. Paul",
    category: "Waterproofing",
    beforeImage: "https://images.unsplash.com/photo-1558618666-fcd25c85cd64?auto=format&fit=crop&w=800&q=80",
    afterImage: "https://images.unsplash.com/photo-1581578731548-c64695cc6952?auto=format&fit=crop&w=800&q=80", 
    description: "Chronic basement flooding during spring thaw. Interior drain tile system with battery backup sump pump provided complete waterproofing solution.",
    customerQuote: "Two years later and our basement is still bone dry. Even during that crazy May storm, we stayed completely dry while neighbors flooded.",
    customerName: "Jennifer Chen",
    timeframe: "3 days",
    year: "2024",
    featured: true
  },
  {
    _id: "3",
    title: "Decorative Concrete Patio",
    location: "Edina, MN", 
    category: "Concrete Work",
    beforeImage: "https://images.unsplash.com/photo-1574947318246-0b707d1b8f42?auto=format&fit=crop&w=800&q=80",
    afterImage: "https://images.unsplash.com/photo-1508898578281-774ac4893e2b?auto=format&fit=crop&w=800&q=80",
    description: "Cracked, settling patio unsafe for family gatherings. Complete replacement with stamped concrete and proper drainage created beautiful entertaining space.",
    customerQuote: "The new patio transformed our backyard into the neighborhood gathering spot. It's been two winters and looks perfect.",
    customerName: "Tom & Lisa Rodriguez",
    timeframe: "5 days", 
    year: "2023",
    featured: true
  },
  {
    _id: "4",
    title: "Suspended Garage Floor Installation",
    location: "Plymouth, MN",
    category: "Concrete Work", 
    beforeImage: "https://images.unsplash.com/photo-1567438073125-66726bdcc1cd?auto=format&fit=crop&w=800&q=80",
    afterImage: "https://images.unsplash.com/photo-1586105251261-72a756497a11?auto=format&fit=crop&w=800&q=80",
    description: "Unusable garage space over walkout basement. Engineered suspended slab with proper load calculations created full 2-car garage without losing basement space.",
    customerQuote: "Incredible engineering. We gained a 2-car garage without losing our basement rec room. It's been flawless for over a year.",
    customerName: "Michelle & Greg Anderson", 
    timeframe: "6 days",
    year: "2023",
    featured: true
  }
];
---

<section id="transformations" class="py-20 sm:py-32 bg-concrete-white">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Header Section -->
    <div class="text-center mb-16">
      <div class="mb-4">
        <span class="inline-block bg-construction-orange px-4 py-2 rounded-full text-sm font-semibold text-white">
          75+ Years of Proven Results
        </span>
      </div>
      <h2 class="font-montserrat font-extrabold text-3xl sm:text-4xl lg:text-5xl text-charcoal-black tracking-tighter mb-6">
        See the <span class="text-construction-orange">Transformation</span>
      </h2>
      <p class="max-w-3xl mx-auto text-lg sm:text-xl text-steel-gray font-lato leading-relaxed">
        Real Minneapolis homes, real solutions, real results. Browse through our recent project transformations to see how we solve challenging foundation, waterproofing, and concrete problems.
      </p>
    </div>

    <!-- Transformation Carousel -->
    <div class="max-w-6xl mx-auto mb-16">
      <!-- Carousel Container -->
      <div class="transformation-carousel relative">
        <div class="carousel-track flex transition-transform duration-500 ease-in-out">
          {transformationProjects.map((project, index) => (
            <div class="carousel-slide flex-shrink-0 w-full">
              <div class="grid lg:grid-cols-2 gap-8 items-center">
                <!-- Before/After Image Section -->
                <div class="relative">
                  <Card class="overflow-hidden shadow-xl">
                    <!-- Before/After Slider -->
                    <div class="relative h-96 before-after-container">
                      <!-- Before Image -->
                      <div class="absolute inset-0">
                        <img
                          src={project.beforeImage}
                          alt={`Before: ${project.title}`}
                          class="w-full h-full object-cover"
                          loading="lazy"
                        />
                        <div class="absolute top-4 left-4 bg-red-600 text-white px-3 py-1 rounded-full text-sm font-semibold">
                          BEFORE
                        </div>
                      </div>
                      
                      <!-- After Image Overlay -->
                      <div class="absolute inset-0 w-1/2 overflow-hidden after-overlay">
                        <img
                          src={project.afterImage}
                          alt={`After: ${project.title}`}
                          class="w-full h-full object-cover absolute top-0 left-0"
                          style="width: 200%;"
                          loading="lazy"
                        />
                        <div class="absolute top-4 right-4 bg-green-600 text-white px-3 py-1 rounded-full text-sm font-semibold">
                          AFTER
                        </div>
                      </div>
                      
                      <!-- Slider Control -->
                      <input
                        type="range"
                        min="0"
                        max="100"
                        value="50"
                        class="comparison-slider absolute inset-0 w-full h-full opacity-0 cursor-ew-resize z-10"
                        aria-label={`Before and after comparison for ${project.title}`}
                      />
                      
                      <!-- Divider Line -->
                      <div class="slider-divider absolute top-0 bottom-0 w-1 bg-white shadow-lg pointer-events-none z-20" style="left: 50%;">
                        <div class="absolute top-1/2 -translate-y-1/2 -left-4 bg-white text-construction-orange rounded-full h-8 w-8 flex items-center justify-center font-bold shadow-lg">
                          ‚ü∑
                        </div>
                      </div>
                    </div>
                  </Card>
                </div>

                <!-- Project Details -->
                <div class="space-y-6">
                  <!-- Project Header -->
                  <div>
                    <div class="flex items-center gap-3 mb-3">
                      <span class="bg-construction-orange/10 text-construction-orange px-3 py-1 rounded-full text-sm font-semibold">
                        {project.category}
                      </span>
                      <span class="text-steel-gray text-sm">{project.year}</span>
                    </div>
                    <h3 class="font-montserrat font-bold text-2xl lg:text-3xl text-charcoal-black mb-2">
                      {project.title}
                    </h3>
                    <p class="text-steel-gray font-medium flex items-center gap-2">
                      <span class="text-construction-orange">üìç</span>
                      {project.location}
                    </p>
                  </div>

                  <!-- Project Description -->
                  <div class="bg-gray-50 border border-gray-200 rounded-lg p-6">
                    <h4 class="font-semibold text-charcoal-black mb-3 flex items-center gap-2">
                      <span class="text-blue-600">üîç</span>
                      The Challenge & Solution
                    </h4>
                    <p class="text-steel-gray leading-relaxed">{project.description}</p>
                    
                    <div class="mt-4 pt-4 border-t border-gray-200">
                      <span class="text-sm text-steel-gray">Project Duration: </span>
                      <span class="font-semibold text-charcoal-black">{project.timeframe}</span>
                    </div>
                  </div>

                  <!-- Customer Testimonial -->
                  <Card class="bg-gradient-to-br from-construction-orange/5 to-bright-yellow/5 border border-construction-orange/20 p-6">
                    <div class="mb-4">
                      <div class="text-construction-orange text-2xl mb-3">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
                      <blockquote class="text-charcoal-black font-medium italic leading-relaxed">
                        "{project.customerQuote}"
                      </blockquote>
                    </div>
                    <footer class="flex items-center justify-between pt-4 border-t border-construction-orange/20">
                      <div>
                        <cite class="not-italic font-semibold text-charcoal-black">
                          {project.customerName}
                        </cite>
                        <p class="text-steel-gray text-sm">{project.location}</p>
                      </div>
                    </footer>
                  </Card>
                </div>
              </div>
            </div>
          ))}
        </div>

        <!-- Navigation Dots -->
        <div class="flex justify-center mt-8 space-x-2">
          {transformationProjects.map((_, index) => (
            <button
              class={`carousel-dot w-3 h-3 rounded-full transition-all ${index === 0 ? 'bg-construction-orange' : 'bg-gray-300 hover:bg-gray-400'}`}
              data-slide={index}
              aria-label={`Go to slide ${index + 1}`}
            ></button>
          ))}
        </div>

        <!-- Navigation Arrows -->
        <button class="carousel-prev absolute left-4 top-1/2 -translate-y-1/2 bg-white/90 hover:bg-white text-charcoal-black rounded-full p-3 shadow-lg transition-all z-30">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
        </button>
        
        <button class="carousel-next absolute right-4 top-1/2 -translate-y-1/2 bg-white/90 hover:bg-white text-charcoal-black rounded-full p-3 shadow-lg transition-all z-30">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
        </button>
      </div>
    </div>

    <!-- Stats Section -->
    <div class="bg-charcoal-black text-white rounded-2xl p-12 mb-16">
      <div class="text-center mb-12">
        <h3 class="font-montserrat font-bold text-3xl mb-4">
          Transform Your Home with <span class="text-construction-orange">Confidence</span>
        </h3>
        <p class="text-gray-300 text-lg max-w-2xl mx-auto">
          Every project shown represents real Minneapolis families who trusted us with their most important investment.
        </p>
      </div>
      
      <div class="grid md:grid-cols-4 gap-8 text-center">
        <div class="transform transition-transform hover:scale-105">
          <div class="text-4xl font-bold text-construction-orange mb-2">2000+</div>
          <div class="text-gray-300">Transformations Completed</div>
        </div>
        <div class="transform transition-transform hover:scale-105">
          <div class="text-4xl font-bold text-construction-orange mb-2">75+</div>
          <div class="text-gray-300">Years of Excellence</div>
        </div>
        <div class="transform transition-transform hover:scale-105">
          <div class="text-4xl font-bold text-construction-orange mb-2">4.8‚òÖ</div>
          <div class="text-gray-300">Customer Rating</div>
        </div>
        <div class="transform transition-transform hover:scale-105">
          <div class="text-4xl font-bold text-construction-orange mb-2">100%</div>
          <div class="text-gray-300">Licensed & Insured</div>
        </div>
      </div>
    </div>

    <!-- Call to Action -->
    <div class="text-center bg-gradient-to-r from-construction-orange to-bright-yellow rounded-2xl p-12 text-white">
      <h3 class="font-montserrat font-bold text-3xl mb-4">
        Ready for Your Transformation?
      </h3>
      <p class="text-xl mb-8 opacity-90 max-w-2xl mx-auto">
        Join thousands of Minneapolis homeowners who've transformed their properties with Gardner Concrete. Your before and after story starts with a free consultation.
      </p>
      <div class="flex flex-col sm:flex-row gap-4 justify-center">
        <Button href="#concrete-booking-form" class="bg-white text-construction-orange hover:bg-gray-100 px-8 py-4 text-lg font-semibold scroll-to-form">
          üõ†Ô∏è Get Your Free Assessment
        </Button>
        <a href="tel:612-825-8779" class="inline-flex items-center justify-center gap-2 px-8 py-4 text-lg font-semibold rounded-lg border-2 border-white text-white hover:bg-white hover:text-construction-orange transition-colors">
          üìû Call (612) 825-8779
        </a>
      </div>
    </div>
  </div>
</section>

<script is:inline>
document.addEventListener('DOMContentLoaded', () => {
  const carouselTrack = document.querySelector('.carousel-track');
  const slides = document.querySelectorAll('.carousel-slide');
  const dots = document.querySelectorAll('.carousel-dot');
  const prevBtn = document.querySelector('.carousel-prev');
  const nextBtn = document.querySelector('.carousel-next'); 
  const comparisonSliders = document.querySelectorAll('.comparison-slider');
  const scrollToFormBtn = document.querySelector('.scroll-to-form');
  
  let currentSlide = 0;
  const totalSlides = slides.length;

  // Initialize carousel
  function updateCarousel() {
    const translateX = -currentSlide * 100;
    carouselTrack.style.transform = `translateX(${translateX}%)`;
    
    // Update dots
    dots.forEach((dot, index) => {
      dot.classList.toggle('bg-construction-orange', index === currentSlide);
      dot.classList.toggle('bg-gray-300', index !== currentSlide);
    });
  }

  // Navigation functions
  function nextSlide() {
    currentSlide = (currentSlide + 1) % totalSlides;
    updateCarousel();
  }

  function prevSlide() {
    currentSlide = (currentSlide - 1 + totalSlides) % totalSlides;
    updateCarousel();
  }

  function goToSlide(index) {
    currentSlide = index;
    updateCarousel();
  }

  // Event listeners
  nextBtn?.addEventListener('click', nextSlide);
  prevBtn?.addEventListener('click', prevSlide);

  dots.forEach((dot, index) => {
    dot.addEventListener('click', () => goToSlide(index));
  });

  // Before/After slider functionality
  comparisonSliders.forEach(slider => {
    slider.addEventListener('input', function() {
      const container = this.closest('.before-after-container');
      const afterOverlay = container.querySelector('.after-overlay');
      const divider = container.querySelector('.slider-divider');
      const percentage = this.value;
      
      afterOverlay.style.width = percentage + '%';
      divider.style.left = percentage + '%';
    });
  });

  // Smooth scroll to form
  scrollToFormBtn?.addEventListener('click', (e) => {
    e.preventDefault();
    const formElement = document.getElementById('concrete-booking-form');
    if (formElement) {
      formElement.scrollIntoView({ 
        behavior: 'smooth', 
        block: 'start' 
      });
    }
  });

  // Auto-advance carousel (optional)
  let autoAdvanceInterval;
  
  function startAutoAdvance() {
    autoAdvanceInterval = setInterval(nextSlide, 8000);
  }
  
  function stopAutoAdvance() {
    clearInterval(autoAdvanceInterval);
  }

  // Start auto-advance
  startAutoAdvance();

  // Pause auto-advance on hover
  const carousel = document.querySelector('.transformation-carousel');
  carousel?.addEventListener('mouseenter', stopAutoAdvance);
  carousel?.addEventListener('mouseleave', startAutoAdvance);

  // Keyboard navigation
  document.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowLeft') prevSlide();
    if (e.key === 'ArrowRight') nextSlide();
  });
});
</script>

<style>
  .carousel-track {
    transition: transform 0.5s ease-in-out;
  }

  .before-after-container {
    position: relative;
    overflow: hidden;
  }

  .after-overlay {
    transition: width 0.1s ease-out;
  }

  .slider-divider {
    transition: left 0.1s ease-out;
  }

  .comparison-slider::-webkit-slider-thumb {
    appearance: none;
    width: 0;
    height: 0;
  }

  .comparison-slider::-moz-range-thumb {
    width: 0;
    height: 0;
    border: none;
    background: transparent;
  }

  .carousel-prev,
  .carousel-next {
    transition: all 0.2s ease;
  }

  .carousel-prev:hover,
  .carousel-next:hover {
    transform: translateY(-50%) scale(1.1);
  }

  .carousel-dot {
    transition: all 0.2s ease;
    cursor: pointer;
  }

  .carousel-dot:hover {
    transform: scale(1.2);
  }

  @media (max-width: 768px) {
    .carousel-prev,
    .carousel-next {
      display: none;
    }
  }
</style>